<!DOCTYPE html>

<html>
<head>
  <title>apiclient.spec.ts</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="apiclient.spec.html">
                  src/apiclient.spec.ts
                </a>
              
                
                <a class="source" href="apiclient.html">
                  src/apiclient.ts
                </a>
              
                
                <a class="source" href="column.spec.html">
                  src/column.spec.ts
                </a>
              
                
                <a class="source" href="column.html">
                  src/column.ts
                </a>
              
                
                <a class="source" href="customlogger.html">
                  src/customlogger.ts
                </a>
              
                
                <a class="source" href="index.spec.html">
                  src/index.spec.ts
                </a>
              
                
                <a class="source" href="index.html">
                  src/index.ts
                </a>
              
                
                <a class="source" href="logger.html">
                  src/logger.ts
                </a>
              
                
                <a class="source" href="record.spec.html">
                  src/record.spec.ts
                </a>
              
                
                <a class="source" href="record.html">
                  src/record.ts
                </a>
              
                
                <a class="source" href="response.spec.html">
                  src/response.spec.ts
                </a>
              
                
                <a class="source" href="response.html">
                  src/response.ts
                </a>
              
                
                <a class="source" href="responseparser.spec.html">
                  src/responseparser.spec.ts
                </a>
              
                
                <a class="source" href="responseparser.html">
                  src/responseparser.ts
                </a>
              
                
                <a class="source" href="responsetemplate.spec.html">
                  src/responsetemplate.spec.ts
                </a>
              
                
                <a class="source" href="responsetemplate.html">
                  src/responsetemplate.ts
                </a>
              
                
                <a class="source" href="responsetemplatemanager.spec.html">
                  src/responsetemplatemanager.spec.ts
                </a>
              
                
                <a class="source" href="responsetemplatemanager.html">
                  src/responsetemplatemanager.ts
                </a>
              
                
                <a class="source" href="socketconfig.spec.html">
                  src/socketconfig.spec.ts
                </a>
              
                
                <a class="source" href="socketconfig.html">
                  src/socketconfig.ts
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>apiclient.spec.ts</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { expect, use } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;chai&quot;</span>; <span class="hljs-comment">// Using Expect style</span>
<span class="hljs-keyword">import</span> { chaiAsPromised } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;chai-promised&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;mocha&quot;</span>;
<span class="hljs-keyword">import</span> nock <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;nock&quot;</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">APIClient</span>,
  <span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_LIVE</span>,
  <span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_OTE</span>,
  <span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_PROXY</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./apiclient.js&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./response.js&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ResponseTemplateManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./responsetemplatemanager.js&quot;</span>;
<span class="hljs-title function_">use</span>(chaiAsPromised);

<span class="hljs-keyword">const</span> apiScript = <span class="hljs-string">&quot;/api/call.cgi&quot;</span>;
<span class="hljs-keyword">const</span> oteHost = <span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_OTE</span>.<span class="hljs-title function_">replace</span>(apiScript, <span class="hljs-string">&quot;&quot;</span>);
<span class="hljs-keyword">const</span> rtm = <span class="hljs-title class_">ResponseTemplateManager</span>.<span class="hljs-title function_">getInstance</span>();
<span class="hljs-keyword">const</span> cmd = { <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span> };
<span class="hljs-keyword">let</span> <span class="hljs-attr">cl</span>: <span class="hljs-title class_">APIClient</span>;

<span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> {
  nock.<span class="hljs-title function_">cleanAll</span>();
});

<span class="hljs-title function_">before</span>(<span class="hljs-function">() =&gt;</span> {
  cl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">APIClient</span>();
  rtm
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;login200&quot;</span>,
      <span class="hljs-string">&quot;[RESPONSE]\r\nPROPERTY[SESSION][0]=h8JLZZHdF2WgWWXlwbKWzEG3XrzoW4yshhvtqyg0LCYiX55QnhgYX9cB0W4mlpbx\r\nDESCRIPTION=Command completed successfully\r\nCODE=200\r\nQUEUETIME=0\r\nRUNTIME=0.169\r\nEOF\r\n&quot;</span>,
    )
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;login500&quot;</span>,
      rtm.<span class="hljs-title function_">generateTemplate</span>(<span class="hljs-string">&quot;530&quot;</span>, <span class="hljs-string">&quot;Authentication failed&quot;</span>),
    )
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;OK&quot;</span>,
      rtm.<span class="hljs-title function_">generateTemplate</span>(<span class="hljs-string">&quot;200&quot;</span>, <span class="hljs-string">&quot;Command completed successfully&quot;</span>),
    )
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;CHECKS&quot;</span>,
      <span class="hljs-string">&quot;[RESPONSE]\r\nPROPERTY[TOTAL][0]=2701\r\nPROPERTY[FIRST][0]=0\r\nPROPERTY[DOMAIN][0]=0-60motorcycletimes.com\r\nPROPERTY[DOMAIN][1]=0-be-s01-0.com\r\nPROPERTY[COUNT][0]=2\r\nPROPERTY[LAST][0]=1\r\nPROPERTY[LIMIT][0]=2\r\nDESCRIPTION=Command completed successfully\r\nCODE=200\r\nQUEUETIME=0\r\nRUNTIME=0.023\r\nEOF\r\n&quot;</span>,
    )
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;listP0&quot;</span>,
      <span class="hljs-string">&quot;[RESPONSE]\r\nPROPERTY[TOTAL][0]=2701\r\nPROPERTY[FIRST][0]=0\r\nPROPERTY[DOMAIN][0]=0-60motorcycletimes.com\r\nPROPERTY[DOMAIN][1]=0-be-s01-0.com\r\nPROPERTY[COUNT][0]=2\r\nPROPERTY[LAST][0]=1\r\nPROPERTY[LIMIT][0]=2\r\nDESCRIPTION=Command completed successfully\r\nCODE=200\r\nQUEUETIME=0\r\nRUNTIME=0.023\r\nEOF\r\n&quot;</span>,
    )
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;listP1&quot;</span>,
      <span class="hljs-string">&quot;[RESPONSE]\r\nPROPERTY[TOTAL][0]=2701\r\nPROPERTY[FIRST][0]=2\r\nPROPERTY[DOMAIN][0]=0-qas-ao17-0.org\r\nPROPERTY[DOMAIN][1]=0-sunnyda222y.com\r\nPROPERTY[COUNT][0]=2\r\nPROPERTY[LAST][0]=3\r\nPROPERTY[LIMIT][0]=2\r\nDESCRIPTION=Command completed successfully\r\nCODE=200\r\nQUEUETIME=0\r\nRUNTIME=0.032\r\nEOF\r\n&quot;</span>,
    )
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;listFP0&quot;</span>,
      <span class="hljs-string">&quot;[RESPONSE]\r\nPROPERTY[TOTAL][0]=3\r\nPROPERTY[FIRST][0]=0\r\nPROPERTY[DOMAIN][0]=0-60motorcycletimes.com\r\nPROPERTY[COUNT][0]=1\r\nPROPERTY[LAST][0]=1\r\nPROPERTY[LIMIT][0]=1\r\nDESCRIPTION=Command completed successfully\r\nCODE=200\r\nQUEUETIME=0\r\nRUNTIME=0.023\r\nEOF\r\n&quot;</span>,
    )
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;listFP1&quot;</span>,
      <span class="hljs-string">&quot;[RESPONSE]\r\nPROPERTY[TOTAL][0]=3\r\nPROPERTY[FIRST][0]=1\r\nPROPERTY[DOMAIN][0]=0-be-s01-0.com\r\nPROPERTY[COUNT][0]=1\r\nPROPERTY[LAST][0]=2\r\nPROPERTY[LIMIT][0]=1\r\nDESCRIPTION=Command completed successfully\r\nCODE=200\r\nQUEUETIME=0\r\nRUNTIME=0.032\r\nEOF\r\n&quot;</span>,
    )
    .<span class="hljs-title function_">addTemplate</span>(
      <span class="hljs-string">&quot;listFP2&quot;</span>,
      <span class="hljs-string">&quot;[RESPONSE]\r\nPROPERTY[TOTAL][0]=3\r\nPROPERTY[FIRST][0]=2\r\nPROPERTY[DOMAIN][0]=0-qas-ao17-0.org\r\nPROPERTY[COUNT][0]=2\r\nPROPERTY[LAST][0]=3\r\nPROPERTY[LIMIT][0]=1\r\nDESCRIPTION=Command completed successfully\r\nCODE=200\r\nQUEUETIME=0\r\nRUNTIME=0.032\r\nEOF\r\n&quot;</span>,
    );
});

<span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;APIClient class&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">timeout</span>(<span class="hljs-title class_">APIClient</span>.<span class="hljs-property">socketTimeout</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">slow</span>(<span class="hljs-number">1000</span>);

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.getPOSTData&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test object input with special chars&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> validate =
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_command=AUTH%3Dgwrgwqg%25%26%5C44t3%2A%0ACOMMAND%3DModifyDomain&quot;</span>;
      <span class="hljs-keyword">const</span> enc = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">AUTH</span>: <span class="hljs-string">&quot;gwrgwqg%&amp;\\44t3*&quot;</span>,
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;ModifyDomain&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(enc).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(validate);
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test string input&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> enc = cl.<span class="hljs-title function_">getPOSTData</span>(<span class="hljs-string">&quot;gregergege&quot;</span>);
      <span class="hljs-title function_">expect</span>(enc).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;s_entity=54cd&amp;s_command=gregergege&quot;</span>);
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test object input with null value in parameter&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> validate = <span class="hljs-string">&quot;s_entity=54cd&amp;s_command=COMMAND%3DModifyDomain&quot;</span>;
      <span class="hljs-keyword">const</span> enc = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">AUTH</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;ModifyDomain&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(enc).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(validate);
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test object input with undefined value in parameter&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> validate = <span class="hljs-string">&quot;s_entity=54cd&amp;s_command=COMMAND%3DModifyDomain&quot;</span>;
      <span class="hljs-keyword">const</span> enc = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">AUTH</span>: <span class="hljs-literal">undefined</span>,
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;ModifyDomain&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(enc).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(validate);
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test data getting secured correctly&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> validate =
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_login=test.user&amp;s_pw=***&amp;s_command=COMMAND%3DCheckAuthentication%0APASSWORD%3D%2A%2A%2A%0ASUBUSER%3Dtest.user&quot;</span>;
      cl.<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;test.user&quot;</span>, <span class="hljs-string">&quot;test.passw0rd&quot;</span>);
      <span class="hljs-keyword">const</span> enc = cl.<span class="hljs-title function_">getPOSTData</span>(
        {
          <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;CheckAuthentication&quot;</span>,
          <span class="hljs-attr">PASSWORD</span>: <span class="hljs-string">&quot;test.passw0rd&quot;</span>,
          <span class="hljs-attr">SUBUSER</span>: <span class="hljs-string">&quot;test.user&quot;</span>,
        },
        <span class="hljs-literal">true</span>,
      );
      cl.<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);
      <span class="hljs-title function_">expect</span>(enc).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(validate);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.enableDebugMode&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;activate debug mode&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">enableDebugMode</span>();
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.disableDebugMode&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;deactivate debug mode&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">disableDebugMode</span>();
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.getSession&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate response&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> session = cl.<span class="hljs-title function_">getSession</span>();
      <span class="hljs-title function_">expect</span>(session).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.getSession&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate response&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> sessid = <span class="hljs-string">&quot;testSessionID12345678&quot;</span>;
      cl.<span class="hljs-title function_">setSession</span>(sessid);
      <span class="hljs-keyword">const</span> session = cl.<span class="hljs-title function_">getSession</span>();
      <span class="hljs-title function_">expect</span>(session).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">equal</span>(sessid);
      cl.<span class="hljs-title function_">setSession</span>(<span class="hljs-string">&quot;&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.getURL&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate default socket url&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> url = cl.<span class="hljs-title function_">getURL</span>();
      <span class="hljs-title function_">expect</span>(url).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_LIVE</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.getUserAgent&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate response&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> ua = cl.<span class="hljs-title function_">getUserAgent</span>();
      <span class="hljs-title function_">expect</span>(ua).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">`NODE-SDK (<span class="hljs-subst">${process.platform}</span>; <span class="hljs-subst">${
          process.arch
        }</span>; rv:<span class="hljs-subst">${cl.getVersion()}</span>) node/<span class="hljs-subst">${process.version}</span>`</span>,
      );
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setUserAgent&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate response&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> cls = cl.<span class="hljs-title function_">setUserAgent</span>(<span class="hljs-string">&quot;WHMCS&quot;</span>, <span class="hljs-string">&quot;7.7.0&quot;</span>);
      <span class="hljs-keyword">const</span> ua = cl.<span class="hljs-title function_">getUserAgent</span>();
      <span class="hljs-title function_">expect</span>(cls).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">APIClient</span>);
      <span class="hljs-title function_">expect</span>(ua).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">`WHMCS (<span class="hljs-subst">${process.platform}</span>; <span class="hljs-subst">${
          process.arch
        }</span>; rv:7.7.0) node-sdk/<span class="hljs-subst">${cl.getVersion()}</span> node/<span class="hljs-subst">${process.version}</span>`</span>,
      );
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate agent string including modules&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> cls = cl.<span class="hljs-title function_">setUserAgent</span>(<span class="hljs-string">&quot;WHMCS&quot;</span>, <span class="hljs-string">&quot;7.7.0&quot;</span>, [
        <span class="hljs-string">&quot;reg/2.6.2&quot;</span>,
        <span class="hljs-string">&quot;ssl/7.2.2&quot;</span>,
        <span class="hljs-string">&quot;dc/8.2.2&quot;</span>,
      ]);
      <span class="hljs-keyword">const</span> ua = cl.<span class="hljs-title function_">getUserAgent</span>();
      <span class="hljs-title function_">expect</span>(cls).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">APIClient</span>);
      <span class="hljs-title function_">expect</span>(ua).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">`WHMCS (<span class="hljs-subst">${process.platform}</span>; <span class="hljs-subst">${
          process.arch
        }</span>; rv:7.7.0) reg/2.6.2 ssl/7.2.2 dc/8.2.2 node-sdk/<span class="hljs-subst">${cl.getVersion()}</span> node/<span class="hljs-subst">${
          process.version
        }</span>`</span>,
      );
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setURL&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate http socket url&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> url = cl.<span class="hljs-title function_">setURL</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_PROXY</span>).<span class="hljs-title function_">getURL</span>();
      <span class="hljs-title function_">expect</span>(url).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_PROXY</span>);
      cl.<span class="hljs-title function_">setURL</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_LIVE</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setOTP&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [otp set] &quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setOTP</span>(<span class="hljs-string">&quot;12345678&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_otp=12345678&amp;s_command=COMMAND%3DStatusAccount&quot;</span>,
      );
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [otp reset]&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setOTP</span>(<span class="hljs-string">&quot;&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;s_entity=54cd&amp;s_command=COMMAND%3DStatusAccount&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setSession&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [session set] &quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setSession</span>(<span class="hljs-string">&quot;12345678&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_session=12345678&amp;s_command=COMMAND%3DStatusAccount&quot;</span>,
      );
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [credentials and session set] &quot;</span>, <span class="hljs-function">() =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>credentials and otp code have to be unset when session id is set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cl.<span class="hljs-title function_">setRoleCredentials</span>(<span class="hljs-string">&quot;myaccountid&quot;</span>, <span class="hljs-string">&quot;myrole&quot;</span>, <span class="hljs-string">&quot;mypassword&quot;</span>)
        .<span class="hljs-title function_">setOTP</span>(<span class="hljs-string">&quot;12345678&quot;</span>)
        .<span class="hljs-title function_">setSession</span>(<span class="hljs-string">&quot;12345678&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_session=12345678&amp;s_command=COMMAND%3DStatusAccount&quot;</span>,
      );
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [session reset]&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setSession</span>(<span class="hljs-string">&quot;&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;s_entity=54cd&amp;s_command=COMMAND%3DStatusAccount&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.saveSession/reuseSession&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setSession</span>(<span class="hljs-string">&quot;&quot;</span>);
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate correct settings&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> sessionobj = {};
      cl.<span class="hljs-title function_">setSession</span>(<span class="hljs-string">&quot;12345678&quot;</span>).<span class="hljs-title function_">saveSession</span>(sessionobj);
      <span class="hljs-keyword">const</span> cl2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">APIClient</span>();
      cl2.<span class="hljs-title function_">reuseSession</span>(sessionobj);
      <span class="hljs-keyword">const</span> tmp = cl2.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_session=12345678&amp;s_command=COMMAND%3DStatusAccount&quot;</span>,
      );
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setRemoteIPAddress&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [ip set] &quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setRemoteIPAddress</span>(<span class="hljs-string">&quot;10.10.10.10&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_remoteaddr=10.10.10.10&amp;s_command=COMMAND%3DStatusAccount&quot;</span>,
      );
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [ip reset]&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setRemoteIPAddress</span>(<span class="hljs-string">&quot;&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;s_entity=54cd&amp;s_command=COMMAND%3DStatusAccount&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setCredentials&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [credentials set] &quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;myaccountid&quot;</span>, <span class="hljs-string">&quot;mypassword&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_login=myaccountid&amp;s_pw=mypassword&amp;s_command=COMMAND%3DStatusAccount&quot;</span>,
      );
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [session reset]&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;s_entity=54cd&amp;s_command=COMMAND%3DStatusAccount&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setRoleCredentials&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [role credentials set] &quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setRoleCredentials</span>(<span class="hljs-string">&quot;myaccountid&quot;</span>, <span class="hljs-string">&quot;myroleid&quot;</span>, <span class="hljs-string">&quot;mypassword&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
        <span class="hljs-string">&quot;s_entity=54cd&amp;s_login=myaccountid%21myroleid&amp;s_pw=mypassword&amp;s_command=COMMAND%3DStatusAccount&quot;</span>,
      );
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate getPOSTData response [role credentials reset]&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setRoleCredentials</span>(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);
      <span class="hljs-keyword">const</span> tmp = cl.<span class="hljs-title function_">getPOSTData</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StatusAccount&quot;</span>,
      });
      <span class="hljs-title function_">expect</span>(tmp).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;s_entity=54cd&amp;s_command=COMMAND%3DStatusAccount&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.login&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [login succeeded; no role used]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> tpl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;login200&quot;</span>).<span class="hljs-title function_">getPlain</span>(), cmd);
      <span class="hljs-title function_">nock</span>(oteHost).<span class="hljs-title function_">post</span>(apiScript).<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, tpl.<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">useOTESystem</span>().<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;test.user&quot;</span>, <span class="hljs-string">&quot;test.passw0rd&quot;</span>);
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">login</span>();
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-keyword">const</span> rec = r.<span class="hljs-title function_">getRecord</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">expect</span>(rec).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
      <span class="hljs-keyword">if</span> (rec) {
        <span class="hljs-keyword">const</span> rec2 = tpl.<span class="hljs-title function_">getRecord</span>(<span class="hljs-number">0</span>);
        <span class="hljs-title function_">expect</span>(rec2).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
        <span class="hljs-keyword">if</span> (rec2) {
          <span class="hljs-title function_">expect</span>(rec.<span class="hljs-title function_">getDataByKey</span>(<span class="hljs-string">&quot;SESSION&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
            rec2.<span class="hljs-title function_">getDataByKey</span>(<span class="hljs-string">&quot;SESSION&quot;</span>),
          );
        }
      }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>skipping test using public accessible role user; we need to review here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    it.<span class="hljs-title function_">skip</span>(<span class="hljs-string">&quot;validate against mocked API response [login succeeded; role used]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> tpl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;login200&quot;</span>).<span class="hljs-title function_">getPlain</span>(), cmd);
      <span class="hljs-title function_">nock</span>(oteHost).<span class="hljs-title function_">post</span>(apiScript).<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, tpl.<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">useOTESystem</span>().<span class="hljs-title function_">setRoleCredentials</span>(
        <span class="hljs-string">&quot;test.user&quot;</span>,
        <span class="hljs-string">&quot;testrole&quot;</span>,
        <span class="hljs-string">&quot;test.passw0rd&quot;</span>,
      );
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">login</span>();
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-keyword">const</span> rec = r.<span class="hljs-title function_">getRecord</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">expect</span>(rec).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
      <span class="hljs-keyword">if</span> (rec) {
        <span class="hljs-keyword">const</span> rec2 = tpl.<span class="hljs-title function_">getRecord</span>(<span class="hljs-number">0</span>);
        <span class="hljs-title function_">expect</span>(rec2).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
        <span class="hljs-keyword">if</span> (rec2) {
          <span class="hljs-title function_">expect</span>(rec.<span class="hljs-title function_">getDataByKey</span>(<span class="hljs-string">&quot;SESSION&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
            rec2.<span class="hljs-title function_">getDataByKey</span>(<span class="hljs-string">&quot;SESSION&quot;</span>),
          );
        }
      }
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [login failed; wrong credentials]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;login500&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;test.user&quot;</span>, <span class="hljs-string">&quot;WRONGPASSWORD&quot;</span>);
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">login</span>();
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isError</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>deactivated as delayConnection is not working together with node-fetch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    it.<span class="hljs-title function_">skip</span>(<span class="hljs-string">&quot;validate against mocked API response [login failed; http timeout]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      nock.<span class="hljs-title function_">cleanAll</span>();
      <span class="hljs-keyword">const</span> tpl = rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;httperror&quot;</span>);
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">delayConnection</span>(<span class="hljs-title class_">APIClient</span>.<span class="hljs-property">socketTimeout</span> + <span class="hljs-number">1000</span>)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, tpl.<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;test.user&quot;</span>, <span class="hljs-string">&quot;WRONGPASSWORD&quot;</span>);
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">login</span>();
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isTmpError</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getDescription</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(tpl.<span class="hljs-title function_">getDescription</span>());
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [login succeeded; no session returned] &quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>this case cannot really happen as the api always returns SESSION property.
this case is just to increase coverage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> tpl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;OK&quot;</span>).<span class="hljs-title function_">getPlain</span>(), cmd);
      <span class="hljs-title function_">nock</span>(oteHost).<span class="hljs-title function_">post</span>(apiScript).<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, tpl.<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">useOTESystem</span>().<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;test.user&quot;</span>, <span class="hljs-string">&quot;test.passw0rd&quot;</span>);
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">login</span>();
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-keyword">const</span> rec = r.<span class="hljs-title function_">getRecord</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">expect</span>(rec).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.loginExtended&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [login succeeded; no role used] &quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> tpl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;login200&quot;</span>).<span class="hljs-title function_">getPlain</span>(), cmd);
      <span class="hljs-title function_">nock</span>(oteHost).<span class="hljs-title function_">post</span>(apiScript).<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, tpl.<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">useOTESystem</span>().<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;test.user&quot;</span>, <span class="hljs-string">&quot;test.passw0rd&quot;</span>);
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">loginExtended</span>({
        <span class="hljs-attr">TIMEOUT</span>: <span class="hljs-number">60</span>,
      });
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-keyword">const</span> rec = r.<span class="hljs-title function_">getRecord</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">expect</span>(rec).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
      <span class="hljs-keyword">if</span> (rec) {
        <span class="hljs-keyword">const</span> rec2 = tpl.<span class="hljs-title function_">getRecord</span>(<span class="hljs-number">0</span>);
        <span class="hljs-title function_">expect</span>(rec2).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
        <span class="hljs-keyword">if</span> (rec2) {
          <span class="hljs-title function_">expect</span>(rec.<span class="hljs-title function_">getDataByKey</span>(<span class="hljs-string">&quot;SESSION&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(
            rec2.<span class="hljs-title function_">getDataByKey</span>(<span class="hljs-string">&quot;SESSION&quot;</span>),
          );
        }
      }
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.logout&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [logout succeeded]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;OK&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">logout</span>();
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [logout failed; session no longer exists]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> tpl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;login200&quot;</span>).<span class="hljs-title function_">getPlain</span>(), cmd);
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;login500&quot;</span>).<span class="hljs-title function_">getPlain</span>());

      <span class="hljs-keyword">const</span> rec2 = tpl.<span class="hljs-title function_">getRecord</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">expect</span>(rec2).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
      <span class="hljs-keyword">if</span> (rec2) {
        <span class="hljs-keyword">const</span> sessid = rec2.<span class="hljs-title function_">getDataByKey</span>(<span class="hljs-string">&quot;SESSION&quot;</span>);
        <span class="hljs-title function_">expect</span>(sessid).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
        <span class="hljs-keyword">if</span> (sessid) {
          cl.<span class="hljs-title function_">enableDebugMode</span>().<span class="hljs-title function_">setSession</span>(sessid);
          <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">logout</span>();
          <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
          <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isError</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
        }
      }
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.request&quot;</span>, <span class="hljs-function">() =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>TODO additional test for statusMessage - not supported through nock [<a href="https://github.com/nock/nock/issues/558%5D">https://github.com/nock/nock/issues/558]</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [200 &lt; r.statusCode &gt; 299]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> tpl2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;httperror&quot;</span>).<span class="hljs-title function_">getPlain</span>(), cmd);
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">404</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;404&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">enableDebugMode</span>()
        .<span class="hljs-title function_">setCredentials</span>(<span class="hljs-string">&quot;test.user&quot;</span>, <span class="hljs-string">&quot;test.passw0rd&quot;</span>)
        .<span class="hljs-title function_">useOTESystem</span>();
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">request</span>(cmd);
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isTmpError</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getCode</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(tpl2.<span class="hljs-title function_">getCode</span>());
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getDescription</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(tpl2.<span class="hljs-title function_">getDescription</span>());
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [200 &lt; r.statusCode &gt; 299, no debug]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> tpl2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;httperror&quot;</span>).<span class="hljs-title function_">getPlain</span>(), cmd);
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">404</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;404&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">disableDebugMode</span>();
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">request</span>(cmd);
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isTmpError</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getCode</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(tpl2.<span class="hljs-title function_">getCode</span>());
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getDescription</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(tpl2.<span class="hljs-title function_">getDescription</span>());
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test if flattening of nested array / bulk parameters works&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;OK&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">request</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;CheckDomains&quot;</span>,
        <span class="hljs-attr">DOMAIN</span>: [<span class="hljs-string">&quot;example.com&quot;</span>, <span class="hljs-string">&quot;example.net&quot;</span>],
      });
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-keyword">const</span> mycmd = r.<span class="hljs-title function_">getCommand</span>();
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(mycmd);
      <span class="hljs-title function_">expect</span>(keys.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;DOMAIN&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">false</span>;
      <span class="hljs-title function_">expect</span>(keys.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;DOMAIN0&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(keys.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;DOMAIN1&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(mycmd.<span class="hljs-property">DOMAIN0</span>).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;example.com&quot;</span>);
      <span class="hljs-title function_">expect</span>(mycmd.<span class="hljs-property">DOMAIN1</span>).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;example.net&quot;</span>);
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test if auto-idn convert works&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      nock.<span class="hljs-title function_">cleanAll</span>();
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">request</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;CheckDomains&quot;</span>,
        <span class="hljs-attr">DOMAIN</span>: [<span class="hljs-string">&quot;example.com&quot;</span>, <span class="hljs-string">&quot;dmin.example&quot;</span>, <span class="hljs-string">&quot;example.net&quot;</span>],
      });
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-keyword">const</span> mycmd = r.<span class="hljs-title function_">getCommand</span>();
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(mycmd);
      <span class="hljs-title function_">expect</span>(keys.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;DOMAIN&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">false</span>;
      <span class="hljs-title function_">expect</span>(keys.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;DOMAIN0&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(keys.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;DOMAIN1&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(keys.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;DOMAIN2&quot;</span>)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(mycmd.<span class="hljs-property">DOMAIN0</span>).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;example.com&quot;</span>);
      <span class="hljs-title function_">expect</span>(mycmd.<span class="hljs-property">DOMAIN1</span>).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;xn--dmin-moa0i.example&quot;</span>);
      <span class="hljs-title function_">expect</span>(mycmd.<span class="hljs-property">DOMAIN2</span>).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;example.net&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.requestNextResponsePage&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [no LAST set]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;listP1&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;listP0&quot;</span>).<span class="hljs-title function_">getPlain</span>(), {
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;QueryDomainList&quot;</span>,
        <span class="hljs-attr">LIMIT</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">FIRST</span>: <span class="hljs-number">0</span>,
      });
      <span class="hljs-keyword">const</span> nr = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">requestNextResponsePage</span>(r);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getRecordsLimitation</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getRecordsCount</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getFirstRecordIndex</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getLastRecordIndex</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">1</span>);
      <span class="hljs-title function_">expect</span>(nr).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
      <span class="hljs-keyword">if</span> (nr) {
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">getRecordsLimitation</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">getRecordsCount</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">getFirstRecordIndex</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">getLastRecordIndex</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">3</span>);
      }
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [LAST set]&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;listP0&quot;</span>).<span class="hljs-title function_">getPlain</span>(), {
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;QueryDomainList&quot;</span>,
        <span class="hljs-attr">LIMIT</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">FIRST</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">LAST</span>: <span class="hljs-number">1</span>,
      });
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">expect</span>(cl.<span class="hljs-title function_">requestNextResponsePage</span>(r)).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">rejectedWith</span>(
        <span class="hljs-title class_">Error</span>,
        <span class="hljs-string">&quot;Parameter LAST in use. Please remove it to avoid issues in requestNextPage.&quot;</span>,
      );
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [no FIRST set]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;listP1&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">disableDebugMode</span>();
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;listP0&quot;</span>).<span class="hljs-title function_">getPlain</span>(), {
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;QueryDomainList&quot;</span>,
        <span class="hljs-attr">LIMIT</span>: <span class="hljs-number">2</span>,
      });
      <span class="hljs-keyword">const</span> nr = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">requestNextResponsePage</span>(r);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getRecordsLimitation</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getRecordsCount</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getFirstRecordIndex</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">getLastRecordIndex</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">1</span>);
      <span class="hljs-title function_">expect</span>(nr).<span class="hljs-property">not</span>.<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">null</span>;
      <span class="hljs-keyword">if</span> (nr) {
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">getRecordsLimitation</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">getRecordsCount</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">getFirstRecordIndex</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title function_">expect</span>(nr.<span class="hljs-title function_">getLastRecordIndex</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">3</span>);
      }
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.requestAllResponsePages&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response [success case]&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">let</span> reqcount = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">const</span> scope = <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">persist</span>()
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, <span class="hljs-function">() =&gt;</span> {
          reqcount++;
          <span class="hljs-keyword">if</span> (reqcount === <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;listFP0&quot;</span>).<span class="hljs-title function_">getPlain</span>();
          }
          <span class="hljs-keyword">if</span> (reqcount === <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">return</span> rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;listFP1&quot;</span>).<span class="hljs-title function_">getPlain</span>();
          }
          <span class="hljs-keyword">return</span> rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;listFP2&quot;</span>).<span class="hljs-title function_">getPlain</span>();
        });
      <span class="hljs-keyword">const</span> nr = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">requestAllResponsePages</span>({
        <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;QueryDomainList&quot;</span>,
        <span class="hljs-attr">FIRST</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">LIMIT</span>: <span class="hljs-number">1</span>,
      });
      <span class="hljs-title function_">expect</span>(nr.<span class="hljs-property">length</span>).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-number">3</span>);
      scope.<span class="hljs-title function_">persist</span>(<span class="hljs-literal">false</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setUserView&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;OK&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">setUserView</span>(<span class="hljs-string">&quot;hexotestman.com&quot;</span>);
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;GetUserIndex&quot;</span> });
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.resetUserView&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;validate against mocked API response&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-title function_">nock</span>(oteHost)
        .<span class="hljs-title function_">post</span>(apiScript)
        .<span class="hljs-title function_">reply</span>(<span class="hljs-number">200</span>, rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;OK&quot;</span>).<span class="hljs-title function_">getPlain</span>());
      cl.<span class="hljs-title function_">resetUserView</span>();
      <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> cl.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;GetUserIndex&quot;</span> });
      <span class="hljs-title function_">expect</span>(r).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-title function_">instanceOf</span>(<span class="hljs-title class_">Response</span>);
      <span class="hljs-title function_">expect</span>(r.<span class="hljs-title function_">isSuccess</span>()).<span class="hljs-property">to</span>.<span class="hljs-property">be</span>.<span class="hljs-property">true</span>;
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setProxy&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test setting proxy works&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setProxy</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);
      <span class="hljs-title function_">expect</span>(cl.<span class="hljs-title function_">getProxy</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);
      cl.<span class="hljs-title function_">setProxy</span>(<span class="hljs-string">&quot;&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.setReferer&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test setting referer works&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">setReferer</span>(<span class="hljs-string">&quot;https://www.hexonet.net&quot;</span>);
      <span class="hljs-title function_">expect</span>(cl.<span class="hljs-title function_">getReferer</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-string">&quot;https://www.hexonet.net&quot;</span>);
      cl.<span class="hljs-title function_">setReferer</span>(<span class="hljs-string">&quot;&quot;</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.useHighPerformanceConnectionSetup&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test setting high performance connection setup works&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">useHighPerformanceConnectionSetup</span>();
      <span class="hljs-title function_">expect</span>(cl.<span class="hljs-title function_">getURL</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_PROXY</span>);
    });
  });

  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;#.useDefaultConnectionSetup&quot;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;test setting default connection setup works&quot;</span>, <span class="hljs-function">() =&gt;</span> {
      cl.<span class="hljs-title function_">useDefaultConnectionSetup</span>();
      <span class="hljs-title function_">expect</span>(cl.<span class="hljs-title function_">getURL</span>()).<span class="hljs-property">to</span>.<span class="hljs-title function_">equal</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_LIVE</span>);
    });
  });
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
